{% extends 'base.html' %}
{% block styles %}
{{ super() }}
<link rel="stylesheet">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
<title>{{ project.name }}</title>
<meta name="theme-color" content="#69b9c4">
<link rel="icon" type="image/png" sizes="1024x1024" href="assets/img/SparkList%20Logo.png">
<link rel="stylesheet" href="{{ url_for('static', filename='bootstrap.min.css') }}">
<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<style>
    .header {
        text-align: center;

        background: linear-gradient(135deg, #3653b4, #3d4b9c);
        color: white;
        height: 5%;
    }

    h1 {
        font-size: 7vw;
    }

    .dark-mode h1 {
        font-size: 7vw;
    }

    /* Reset default margin and padding for lists */
    ul {
        margin: 0;
        padding: 0;
        list-style: none;
    }

    /* Style the bottom navigation */
    .tab {
        position: fixed;
        bottom: 0;
        width: 100%;
        display: flex;
        justify-content: space-between;
        background-color: #e5dfdf;
        box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
        z-index: 2;
        /* Set a higher z-index value */

    }

    .dark-mode .tab {
        position: fixed;
        bottom: 0;
        width: 100%;
        display: flex;
        justify-content: space-between;
        background-color: #222;
        box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);

    }

    /* Style each tab button */
    .tab button {
        flex-grow: 1;
        padding: 10px 0;
        text-align: center;
        background-color: inherit;
        border-top: 1px solid #16cac4;
        outline: none;
        cursor: pointer;
        transition: background-color 0.3s;
        color: rgb(240, 234, 234);
        background-color: #244fb2;
    }

    .dark-mode .tab button {
        flex-grow: 1;
        padding: 10px 0;
        text-align: center;
        background-color: inherit;
        border: 1px solid #16cac4;
        cursor: pointer;
        transition: background-color 0.3s;
        color: rgb(240, 234, 234);
        background-color: #244fb2;
    }

    /* Change background color on hover */
    .tab button:hover {
        background-color: #183b8d;
    }

    /* Style the active tab button */
    .tab button.active {
        background-color: #386be3;
    }

    /* Style the tab content */
    .tabcontent {
        display: none;
        padding: 2px;
    }

    /* Ensure active tab content is displayed */
    .tabcontent.active {
        display: block;
    }

    .projects {
        display: flex;
        /* Use flexbox to align items in a row */
        align-items: baseline;
        /* Align items along the baseline */
        width: 85%;
        /* Adjust the width as needed */
        margin: 10px 0;
        /* Add margin for spacing */

    }

    /* Style the input form */
    .projects {
        display: flex;
        align-items: center;
        /* Center items vertically */
        width: 300px;
        margin: 10px 0;
    }

    input#bracketbox {
        width: 60px;
        margin-right: 10px;
        color: black;
    }

    .projects .progress {
        flex-grow: 1;
        height: 20px;
        margin-left: 10px;
    }

    .progress {
        align-self: flex-start;
    }

    .mode-toggle {
        text-align: center;
        padding: 10px;
        position: fixed;
        /* Set to 'fixed' to position it relative to the viewport */
        bottom: 60px;
        /* Adjust this value to control the distance from the bottom */
        right: 20px;
        /* Adjust this value to control the distance from the right */
        text-align: center;
        padding: 10px;
    }

    /* Adjust the size of the progress bar */
    .progress {
        height: 10px;
        /* Adjust the height as needed */
    }

    /* Style for the input and quantity */
    .input-container {
        display: inline-block;
        margin-left: 10px;
    }

    /* Style for the progress bar and progress text */
    .progress-container {
        display: flex;
        align-items: center;
        margin-top: 5px;
        /* Add margin as needed */
    }

    /* Style for the progress text */
    #current-progress {
        margin-left: 5px;
    }


    strong {
        font-weight: bold;
    }

    .display-inline-block {
        display: inline-block;
    }


    /* Existing styles ... */

    /* Style for the persistent buttons */
    .persistent-buttons {
        display: flex;
        flex-direction: row;
        /* Stack buttons vertically */
        align-items: center;
        /* Center buttons horizontally */
        margin: 30px 0;
        /* Add margin to move buttons down */
    }

    .styled-link,
    .styled-link-projects {
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #474748fe;
        color: #ebebeb;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);

        width: 15%;
        /* Adjust the width as needed */
        text-decoration: none;
        transition: background-color 0.3s;
        margin-top: 15px;
    }

    .styled-link:hover,
    .styled-link-projects:hover {
        background-color: #0c635b;
    }

    /* Additional styles ... */

    strong {
        font-weight: bold;
    }

    .display-inline-block {
        display: inline-block;
    }

    table {
        width: 100%;
        border: 1px solid #b3adad;
        border-collapse: collapse;
        padding: 5px;
    }

    table th {
        border: 1px solid #b3adad;
        padding: 5px;
        background: #404040;
        color: #a29a9a;
    }

    td .special-column {
        border: 1px solid #790b0b;
        text-align: left;
        padding: 5px;
        background: #cc3030;
        color: #9cd256;
    }

    td {
        border: 1px solid #b3adad;
        text-align: left;
        padding: 5px;
        background: #3e3d3d;
        color: #56bdd2;
    }

    td .special-column {
        border: 1px solid #790b0b;
        text-align: left;
        padding: 5px;
        background: #cc3030;
        color: #9cd256;
    }

    .accordion {
        --bs-accordion-btn-icon: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='%23333' xmlns='http://www.w3.org/2000/svg'%3e%3cpath fill-rule='evenodd' d='M8 0a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2H9v6a1 1 0 1 1-2 0V9H1a1 1 0 0 1 0-2h6V1a1 1 0 0 1 1-1z' clip-rule='evenodd'/%3e%3c/svg%3e");
        --bs-accordion-btn-icon-width: 2rem;
        --bs-accordion-btn-icon-color: orange;
        --bs-accordion-btn-icon-transition: transform 0.2s ease-in-out;
        --bs-accordion-btn-active-icon: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='%23333' xmlns='http://www.w3.org/2000/svg'%3e%3cpath fill-rule='evenodd' d='M0 8a1 1 0 0 1 1-1h14a1 1 0 1 1 0 2H1a1 1 0 0 1-1-1z' clip-rule='evenodd'/%3e%3c/svg%3e");

    }

    /* Style for plus and minus icons */
    .plus-icon,
    .minus-icon {
        float: right;
        margin-left: 10px;
        /* Adjust the margin as needed to control the spacing between the text and icons */
        font-weight: bold;
        /* You can style the icons as desired */
        font-size: 18px;
        /* You can adjust the font size */
    }

    /* Hide the minus icon by default */
    .minus-icon {
        display: none;
    }

    .accordion .fa {
        margin-right: 0.5rem;
    }

    .accordion button,
    .accordion button:hover,
    .accordion button:focus {
        text-decoration: none;
    }

    .tabcontent {
        display: none;
        padding: 2px;
        width: 100%;
        /* Increase the width of the containers */
        word-wrap: break-word;
        /* Add text wrapping */
    }

    /* Ensure active tab content is displayed */
    .tabcontent.active {
        display: block;
    }



    .tablinks {
        display: flex;
        align-items: center;
        /* Center vertically */
        justify-content: center;
        /* Center horizontally */
        padding: 10px;
        /* Adjust padding as needed */
    }

    .material-symbols-outlined {
        margin-right: 5px;
        /* Add some space between the icon and text */
    }

    .button-text {
        font-size: 16px;
        /* Adjust font size as needed */
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        /* Center vertically */
        justify-content: left;
        /* Center horizontally */
        text-decoration: none;
        /* Remove default underline */
        padding: 10px;
        /* Adjust padding as needed */
    }

    .custom-button {
        display: flex;
        align-items: center;
        /* Center vertically */
        justify-content: center;
        /* Center horizontally */
    }

    /*Functional Styling*/
    @media (pointer: coarse),
    (hover: none) {
        [title] {
            position: relative;
            display: inline-flex;
            justify-content: center;
        }

        [title]:focus::after {
            content: attr(title);
            position: absolute;
            top: 90%;
            color: #000;
            background-color: #fff;
            border: 1px solid;
            width: -mozfit-content;
            padding: 3px;
            font-size: 18px;
        }

    }
</style>
{% endblock %}
{% block content %}

<body style="--bs-body-bg: #333;background: #333333; margin-bottom:50px;">
    <div class="tab">
        <button class="tablinks" onclick="openTab(event, 'formQuantities')">
            <span class="material-symbols-outlined">electrical_services</span>
            Devices List
        </button>
        <button class="tablinks" onclick="openTab(event, 'projectMaterials')">
            <span class="material-symbols-outlined">bolt</span>
            Materials List
        </button>
        <button class="tablinks" onclick="openTab(event, 'todo_list')">
            <span class="material-symbols-outlined">list</span>
            <span class="button-text">To-Do List</span>
        </button>
    </div>
    <div class="btn-group" style="width:20%;
                    padding:20px;
                    align-items: center">
        <button type="button" class="btn btn-primary dropdown-toggle custom-button" data-toggle="dropdown"
            aria-haspopup="true" aria-expanded="false">
            <span class="material-symbols-outlined">more_vert</span>
            <span class="button-text">More Options</span>
        </button>
        <div class="dropdown-menu">
            <a class="dropdown-item" href="{{ url_for('edit_form_quantities', project_id=project.id) }}"><span
                    class="material-symbols-outlined">edit</span> Edit Device
                Quantity</a>
            <a class="dropdown-item" href="{{ url_for('download', project_id=project_id) }}"><span
                    class="material-symbols-outlined">save</span> Save Material
                List </a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="{{ url_for('view_projects') }}"><span
                    class="material-symbols-outlined">rocket</span> View
                Projects </a>
            <a class="dropdown-item" href="{{ url_for('home') }}"><span class="material-symbols-outlined">home</span>
                Home </a>
            <a class="dropdown-item" style="color: red" href="javascript:void(0);"
                onclick="deleteProject({{ project_id }})">
                <span class="material-symbols-outlined">delete</span>
                <span class="button-text">Delete Project</span>
            </a>
        </div>
    </div>
    <div id="formQuantities" class="tabcontent" style="background-color:#222">
        <h2 class="selected_job w3-center" style="color: green">
            {{ project.name }}
        </h2>
        {% set categories = {} %}
        {% for entry in form_entries %}
        {% set device = entry.form_label.name %}
        {% set category = entry.form_label.category %}
        {% set
        quantity = entry.form_quantity %}
        {% if category not in categories %}
        {%
        set _
        = categories.update({category: {device: quantity}}) %}
        {% else %}
        {% set
        _ =
        categories[category].update({device: quantity}) %}
        {% endif %}
        {% endfor
        %}
        {%
        for category, devices in categories.items() %}

        <div style="border-width:2px;
                background-color:#2f2f2f;
                padding:5px" class="{{ category|lower }} w3-responsive" id="{{ category|lower }}outlets">

            <table w3-responsive>
                <tr>
                    <th>Device</th>
                    <th>Quantity</th>
                    <div class="category-container">
                        {% for device, quantity in devices.items() %}
                </tr>
                <tr>
                    <td style="background-color:#343333">{{ device }}</td>
                    <td style="background-color:#343333">{{ quantity }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
        {% endfor %}
    </div>
    <!-- materials tab -->
    <div id="projectMaterials" class="tabcontent">
        <h2 class="selected_job w3-center" style="margin: 0 auto; color:green;">
            {{ project.name }}
        </h2>
        {% macro buttons() %}
        {% endmacro %}
        <table class="w3-responsive">
            <tr>
                <th>Material</th>
                <th>Quantity</th>
            </tr>
            {% for material in materials %}
            {% if material.quantity > 0 %}
            <tr>
                <td class="special-column">{{ material.name }}</td>
                <td class="w3-center  w3-text-orange">
                    {{ material.quantity
                    }}
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </table>
    </div>
    <!-- To-do tab -->
    <div id="todo_list" class="tabcontent active">
        <h2 class="mx-auto w3-center" style="margin: 0 auto; color:green;">{{ project.name }} Materials</h2>

        <div class="container-lg">
            {% for container_name, container_percentage in container_average.items() %}
            <div>
                <div id="{{ container_name }} collapse-2" class="show" style="width:100%;">
                    <div id="accordion-1" class="accordion" role="tablist" style="width:100%;">
                        <div class="accordion-item" style="background:#222;
                                    margin-bottom:20px;
                                    width:100%;
                                    border-radius: 10px;
                                    color: #212529;
                                    border: 4px solid rgb(55,192,211);
                                    border-top-color: rgb(42,130,157);
                                    border-right-color: rgb(42,130,157);
                                    border-bottom-color: rgb(42,130,157);
                                    border-left-width: 4px;
                                    border-left-color: rgb(42,130,157)">
                            <h2 class="accordion-header w3-centered" role="tab" style="width:100%;">
                                <button
                                    class="collapsed accordion-button btn btn-primary d-md-flex justify-content-md-center"
                                    type="button" data-bs-toggle="collapse"
                                    data-bs-target="#accordion-1 .item-{{ loop.index }}" aria-expanded="false"
                                    href="#{{ container_name }}"
                                    aria-controls="accordion-1 .item-{{ loop.index }} {{ container_name }}" style="text-align: center;
                                               background: #222;
                                               font-size: large;
                                               border-bottom: 2px orange solid;
                                               color: orange">
                                    <strong class="w3-responsive">{{ container_name }} - {{
                                        container_percentage|format_as_integer
                                        }}%</strong>
                                </button>
                                <div id="{{ container_name }} collapse-2" class="show"></div>
                                <div class="gradient-line"></div>
                            </h2>
                            <div class="accordian-body">
                                <div class="card accordion-collapse collapse show item-{{ loop.index }}" style="background: #222222;
                                            margin-bottom: 20px" role="tabpanel"
                                    data-bs-parent="#accordion-1 .item-{{ loop.index }}">
                                    <form method="POST"
                                        action="{{ url_for('update_progress', project_id=project.id) }}">
                                        <div class="card-header" style="border-bottom: 2px solid rgba(66,131,64,0.176)">
                                            <div class="row">
                                                <div class="col-sm-7 col-md-5">
                                                    <div class="fs-4 fs" style="color: rgb(255,255,255);">
                                                        {{
                                                        container_name }}:
                                                    </div>
                                                </div>
                                                <div class="col">
                                                    <div class="progress">
                                                        <div class="progress-bar bg-success progress-bar-animated"
                                                            aria-valuenow="{{ container_percentage|format_as_integer }}"
                                                            aria-valuemin="0" aria-valuemax="100"
                                                            style="width: {{ container_percentage|format_as_integer }}%">
                                                            {{
                                                            container_percentage|format_as_integer
                                                            }}%
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div
                                                        class="col d-md-flex justify-content-md-end align-items-md-end">
                                                        <strong
                                                            class="float-end d-md-flex justify-content-md-end align-items-md-end"
                                                            style="color: var(--bs-gray-300)">Total
                                                            Quantity: ({{
                                                            gfci +
                                                            outlets + data
                                                            + switches + ff3
                                                            +
                                                            ff4 }})
                                                        </strong>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-body" style="background: #2b2c2b;
                                                        color: var(--bs-gray-400)">
                                                <span>
                                                    {% for
                                                    task_name, task_info in
                                                    task_data.items() if
                                                    task_info['container']
                                                    ==
                                                    container_name %}
                                                    {% set task = task_info %}
                                                </span>
                                                <div class="row justify-content-end" style="margin:10px; font-size: clamp(12px, 2.5vw, 24px);">
                                                    
                                                    <div class="col-md-10">
                                                        <div class="d-flex justify-content-end align-items-center">
                                                            <a style="color:white; font-size: 1.2rem; " title="{{ task.tooltip }}" tabindex="0">{{ task_name }}</a>

                                                            <input class="form-control-sm" type="number"
                                                                name="progress_{{ task_name }}"
                                                                value="{{ task_info['current_progress'] }}" style="width: 80px;
                                                                  background: #222;
                                                                  color: #d76c1f;
                                                                  font: x-large;">
                                                            <div class="form-label" style="font-size: 14px; white-space: nowrap;">
                                                                &nbsp;Out of {{ math.trunc(task_info['target_quantity']) }}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div class="progress">
                                                            <div class="progress-bar bg-success progress-bar-animated"
                                                                aria-valuenow="{{ calculate_progress_percentage(task_info['current_progress'], task_info['target_quantity']) }}"
                                                                aria-valuemin="0" aria-valuemax="100"
                                                                style="width: {{ calculate_progress_percentage(task_info['current_progress'], task_info['target_quantity']) }}%">
                                                                {{ calculate_progress_percentage(task_info['current_progress'], task_info['target_quantity']) }}%
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {% endfor %}
                                            </div>
                                            <button id="progressButton"
                                                class="btn btn-primary d-block icon-button w-100" type="submit">
                                                <i class="fa fa-user"></i><span>Submit</span>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";

            // Update the fragment identifier in the URL to the current tab
            window.location.hash = tabName;
        }
        function openTabFromFragment() {
            const fragment = window.location.hash.substring(1); // Get the fragment identifier
            const tab = document.getElementById(fragment); // Find the tab content div

            if (tab) {
                // If the tab content div exists, open it
                tab.style.display = "block";
                const tablink = document.querySelector(`.tablinks[href="#${fragment}"]`);
                if (tablink) {
                    tablink.click(); // Trigger a click on the corresponding tab link
                }
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            openTabFromFragment();
        });

        document.addEventListener("DOMContentLoaded", function () {
            // Add an event listener to the button
            document.getElementById("progressButton").addEventListener("click", function () {
                // Call the openTab function to switch to the desired tab
                openTab(null, "todo_list"); // Replace "otherTabName" with the ID of the tab you want to switch to
            });
        });

        function deleteProject(projectId) {
            if (confirm("Are you sure you want to delete this project?")) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("delete_project", project_id=project.id) }}';


                document.body.appendChild(form);
                form.submit();
            }
        }



        // Add JavaScript to toggle plus and minus icons
        document.addEventListener('DOMContentLoaded', function () {
            const accordionButtons = document.querySelectorAll('.accordion-button');

            accordionButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    const plusIcon = button.querySelector('.plus-icon');
                    const minusIcon = button.querySelector('.minus-icon');
                    plusIcon.style.display = plusIcon.style.display === 'none' ? '' : 'none';
                    minusIcon.style.display = minusIcon.style.display === 'none' ? '' : 'none';
                });
            });
        });
        $(document).ready(function () {
            // Add minus icon for collapse element which is open by default
            $(".collapse.show").each(function () {
                $(this)
                    .prev(".accordion-header")
                    .find(".fa")
                    .addClass("fa-minus")
                    .removeClass("fa-plus");
            });

            // Toggle plus minus icon on show hide of collapse element
            $(".collapse")
                .on("show.bs.collapse", function () {
                    $(this)
                        .prev(".accordion-header")
                        .find(".fa")
                        .removeClass("fa-plus")
                        .addClass("fa-minus");
                })
                .on("hide.bs.collapse", function () {
                    $(this)
                        .prev(".accordion-header")
                        .find(".fa")
                        .removeClass("fa-minus")
                        .addClass("fa-plus");
                });
        });



    </script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <script type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="static/index.js"></script>
</body>
{% endblock %}